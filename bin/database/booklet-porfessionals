#!/usr/bin/env bash

IFS="#"
CURRENT=""
psql -t -AF "#" -c "

    SELECT
        registration.company,
        person.firstname,
        person.lastname
     FROM
        registration,
        person
     WHERE
        company IS NOT NULL
        AND
        registration.person_id = person.id
        AND
        type = 'Professional'
        AND
        (
            registration.id IN (
                                SELECT
                                    rego
                                FROM
                                    rego_invoice_payment
                                WHERE
                                    payment > 0
                               )
            OR
            registration.id in (
                            SELECT
                                id
                            FROM
                                speaker_rego
                           )
            OR
            registration.id in (
                            SELECT
                                registration.id
                            FROM
                                registration,
                                voucher_code
                            WHERE
                                voucher_code = voucher_code.code
                           )
        )
    ORDER BY
        company,
        lastname,
        firstname
" | \
while read COMPANY FIRSTNAME LASTNAME
do
    if [ "$COMPANY" != "$CURRENT" ]
    then
        echo "$COMPANY"
    fi
    echo -e "\t$FIRSTNAME $LASTNAME"
    CURRENT="$COMPANY"
done
