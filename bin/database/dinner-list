#!/bin/sh

psql -c "
    SELECT DISTINCT
        person.id,
        person.firstname || ' ' || person.lastname AS name,
        r.dinner AS tickets
    FROM
        person
    JOIN (
            SELECT
                person_id,
                CASE WHEN
                    registration.type = 'Professional' 
                THEN
                    1 
                WHEN
                    registration.type in ('Hobbyist', 'Concession')
                    AND
                    registration.voucher_code IN (
                                                    SELECT
                                                        code
                                                    FROM
                                                        voucher_code
                                                  )
                THEN
                    1
                WHEN
                    registration.id IN (
                                            SELECT
                                                id
                                            FROM
                                                speaker_rego
                                       )
                THEN
                    1
                ELSE
                    0
                END
                + registration.dinner AS dinner 
            FROM
                registration,
                 rego_invoice_payment
            WHERE
                (
                    rego_invoice_payment.payment > 0
                    OR
                    registration.id IN (
                                            SELECT
                                                id
                                            FROM
                                                speaker_rego
                                       )
                    OR
                    registration.voucher_code IN (
                                                    SELECT
                                                        code
                                                    FROM 
                                                        voucher_code
                                                   )
                )
                AND
                rego_invoice_payment.rego = registration.id
            ) AS r 
    ON
        person.id = r.person_id
    WHERE
        r.dinner > 0
    ORDER BY
        name
 "

echo "      | Penelope Robinson         | 1"
echo "      | Gernot Heiser             | 2"
echo "      | Media                     | 2"
echo "      | Babysitters for creche    | 5"
