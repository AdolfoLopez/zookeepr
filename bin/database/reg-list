#!/bin/sh
IFS='#'

type=$1

if [ -z $type ]
then
    echo "Usage: $0 hobby|prof|speakers"
    exit 1
fi

type=$1
normal_clause="
    AND
    person.id = registration.person_id
    AND
    rego_invoice_payment.cost = rego_invoice_payment.dollars
    AND
    rego_invoice_payment.payment IS NOT NULL
    AND
    rego_invoice_payment.rego = registration.id
    $extra_where
"

case $type in
    "hobby")
        rego_type="('Hobbyist', 'Concession')"
        where_clause="
            AND
            registration.type IN $rego_type
            $normal_clause
        "
        ;;

    "prof")
        rego_type="('Professional')"
        where_clause="
            AND
            registration.type IN $rego_type
            $normal_clause
        "
        ;;
    "speakers")
        where_clause="
            AND
            registration.person_id = person.id
            AND
            proposal.id = person_proposal_map.proposal_id
            AND
            person.id = person_proposal_map.person_id
            AND
            person.account_id = account.id
            AND
            proposal.proposal_type_id = proposal_type.id
            AND
            proposal.accepted = true
        "
        extra_tables="
            person_proposal_map,
            proposal_type,
            proposal,
        "
        ;;
    *)
        echo "Invalid rego type"
        exit 1
        ;;
esac

psql -t -c "
    SELECT DISTINCT
        person.firstname || ' ' || person.lastname,
        substr(account.email_address, 0, 30),
        person.id,
        registration.teesize
    FROM
        person,
        registration,
        rego_invoice_payment,
        $extra_tables
        account
    WHERE
        NOT registration.present
        AND
        person.account_id = account.id
        $where_clause
    ORDER BY
        person.firstname || ' ' || person.lastname ASC
"
